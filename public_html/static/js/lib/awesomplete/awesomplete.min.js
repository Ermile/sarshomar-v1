// Awesomplete - Lea Verou - MIT license
!function(){function t(t){var e=Array.isArray(t)?{label:t[0],value:t[1]}:"object"==typeof t&&"label"in t&&"value"in t?t:{label:t,value:t};this.label=e.label||e.value,this.value=e.value}function e(t,e,i){for(var n in e){var s=e[n],r=t.input.getAttribute("data-"+n.toLowerCase());"number"==typeof s?t[n]=parseInt(r):s===!1?t[n]=null!==r:s instanceof Function?t[n]=null:t[n]=r,t[n]||0===t[n]||(t[n]=n in i?i[n]:s)}}function i(t,e){return"string"==typeof t?(e||document).querySelector(t):t||null}function n(t,e){return o.call((e||document).querySelectorAll(t))}function s(){n("input.awesomplete").forEach(function(t){new r(t)})}var r=function(t,n){var s=this;this.isOpened=!1,this.input=i(t),this.input.setAttribute("autocomplete","off"),this.input.setAttribute("aria-autocomplete","list"),n=n||{},e(this,{minChars:2,maxItems:10,autoFirst:!1,data:r.DATA,filter:r.FILTER_CONTAINS,sort:r.SORT_BYLENGTH,item:r.ITEM,replace:r.REPLACE},n),this.index=-1,this.container=i.create("div",{className:"awesomplete",around:t}),this.ul=i.create("ul",{hidden:"hidden",inside:this.container}),this.status=i.create("span",{className:"visually-hidden",role:"status","aria-live":"assertive","aria-relevant":"additions",inside:this.container}),i.bind(this.input,{input:this.evaluate.bind(this),blur:this.close.bind(this,{reason:"blur"}),keydown:function(t){var e=t.keyCode;s.opened&&(13===e&&s.selected?(t.preventDefault(),s.select()):27===e?s.close({reason:"esc"}):38!==e&&40!==e||(t.preventDefault(),s[38===e?"previous":"next"]()))}}),i.bind(this.input.form,{submit:this.close.bind(this,{reason:"submit"})}),i.bind(this.ul,{mousedown:function(t){var e=t.target;if(e!==this){for(;e&&!/li/i.test(e.nodeName);)e=e.parentNode;e&&0===t.button&&(t.preventDefault(),s.select(e,t.target))}}}),this.input.hasAttribute("list")?(this.list="#"+this.input.getAttribute("list"),this.input.removeAttribute("list")):this.list=this.input.getAttribute("data-list")||n.list||[],r.all.push(this)};r.prototype={set list(t){if(Array.isArray(t))this._list=t;else if("string"==typeof t&&t.indexOf(",")>-1)this._list=t.split(/\s*,\s*/);else if(t=i(t),t&&t.children){var e=[];o.apply(t.children).forEach(function(t){if(!t.disabled){var i=t.textContent.trim(),n=t.value||i,s=t.label||i;""!==n&&e.push({label:s,value:n})}}),this._list=e}document.activeElement===this.input&&this.evaluate()},get selected(){return this.index>-1},get opened(){return this.isOpened},close:function(t){this.opened&&(this.ul.setAttribute("hidden",""),this.isOpened=!1,this.index=-1,i.fire(this.input,"awesomplete-close",t||{}))},open:function(){this.ul.removeAttribute("hidden"),this.isOpened=!0,this.autoFirst&&this.index===-1&&this.goto(0),i.fire(this.input,"awesomplete-open")},next:function(){var t=this.ul.children.length;this.goto(this.index<t-1?this.index+1:t?0:-1)},previous:function(){var t=this.ul.children.length,e=this.index-1;this.goto(this.selected&&e!==-1?e:t-1)},goto:function(t){var e=this.ul.children;this.selected&&e[this.index].setAttribute("aria-selected","false"),this.index=t,t>-1&&e.length>0&&(e[t].setAttribute("aria-selected","true"),this.status.textContent=e[t].textContent,i.fire(this.input,"awesomplete-highlight",{text:this.suggestions[this.index]}))},select:function(t,e){if(t?this.index=i.siblingIndex(t):t=this.ul.children[this.index],t){var n=this.suggestions[this.index],s=i.fire(this.input,"awesomplete-select",{text:n,origin:e||t});s&&(this.replace(n),this.close({reason:"select"}),i.fire(this.input,"awesomplete-selectcomplete",{text:n}))}},evaluate:function(){var e=this,i=this.input.value;i.length>=this.minChars&&this._list.length>0?(this.index=-1,this.ul.innerHTML="",this.suggestions=this._list.map(function(n){return new t(e.data(n,i))}).filter(function(t){return e.filter(t,i)}).slice(0,this.maxItems),this.suggestions.forEach(function(t){e.ul.appendChild(e.item(t,i))}),0===this.ul.children.length?this.close({reason:"nomatches"}):this.open()):this.close({reason:"nomatches"})}},r.all=[],r.FILTER_CONTAINS=function(t,e){return RegExp(i.regExpEscape(e.trim()),"i").test(t)},r.FILTER_STARTSWITH=function(t,e){return RegExp("^"+i.regExpEscape(e.trim()),"i").test(t)},r.SORT_BYLENGTH=function(t,e){return t.length!==e.length?t.length-e.length:t<e?-1:1},r.ITEM=function(t,e){var n=""===e?t:t.replace(RegExp(i.regExpEscape(e.trim()),"gi"),"<mark>$&</mark>");return i.create("li",{innerHTML:n,"aria-selected":"false"})},r.REPLACE=function(t){this.input.value=t.value},r.DATA=function(t){return t},Object.defineProperty(t.prototype=Object.create(String.prototype),"length",{get:function(){return this.label.length}}),t.prototype.toString=t.prototype.valueOf=function(){return""+this.label};var o=Array.prototype.slice;return i.create=function(t,e){var n=document.createElement(t);for(var s in e){var r=e[s];if("inside"===s)i(r).appendChild(n);else if("around"===s){var o=i(r);o.parentNode.insertBefore(n,o),n.appendChild(o)}else s in n?n[s]=r:n.setAttribute(s,r)}return n},i.bind=function(t,e){if(t)for(var i in e){var n=e[i];i.split(/\s+/).forEach(function(e){t.addEventListener(e,n)})}},i.fire=function(t,e,i){var n=document.createEvent("HTMLEvents");n.initEvent(e,!0,!0);for(var s in i)n[s]=i[s];return t.dispatchEvent(n)},i.regExpEscape=function(t){return t.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")},i.siblingIndex=function(t){for(var e=0;t=t.previousElementSibling;e++);return e},"undefined"!=typeof Document&&("loading"!==document.readyState?s():document.addEventListener("DOMContentLoaded",s)),r.$=i,r.$$=n,"undefined"!=typeof self&&(self.Awesomplete=r),"object"==typeof module&&module.exports&&(module.exports=r),r}();


/**
 * [fillAuto description]
 * @return {[type]} [description]
 */
function fillAuto()
{
	// // for each elements using autoList create variable
	$('.autoList').each(function(_el)
	{
		// bind list data
		bindAwesomplete.call(this);

		var parentEl = $($(this).attr('data-parent'));
		if(parentEl.length)
		{
			// if has data
			if(parentEl.val() || $(this).val())
			{
				// do nothing
			}
			else
			{
				$(this).attr('disabled', '');
			}
		}
	});
	// on change input of each list call fill datalist func
	$(document).on('input', '.autoList', function(e)
	{
		var $this          = $(this);
		var search_timeout = $this.attr('data-search-timeout');
		if(search_timeout)
		{
			clearTimeout(search_timeout);
		}
		var timeout = setTimeout(function()
		{
			if($this.val().trim().length > 1)
			{
				fillDataList($this);
			}
			// disable child on change
			var myChild = $('.autoList[data-parent="#' + $this.attr('id') + '"]')
			myChild.attr('disabled', '');
			// remove data-search-timeout attr
			$this.attr('data-search-timeout', null);
		}, 300);
		$this.attr('data-search-timeout', timeout);

	});

	// on each autoList after select add as tag
	$(document).on('awesomplete-selectcomplete', ".autoList", function()
	{
		// if this field is parent of another, enable and transfer focus to it
		var myChild = $('.autoList[data-parent="#' + this.id + '"]')
		myChild.attr('disabled', null);
		myChild.focus();
		// call func if needed
		var myFunc = $(this).attr('data-call');
		// if function exist and callable
		if(myFunc && callFunction(myFunc, null, true))
		{
			callFunction(myFunc, this);
		}
	});
	// bind after add new opt
	$(document).on("addNewOpt", function(_obj, _el, _value)
	{
		var newEl = $(_el).find('input.autoList')[0];
		if(newEl)
		{
			bindAwesomplete.call(newEl);
		}
	});
}


/**
 * [bindAwesomplete description]
 * @return {[type]} [description]
 */
function bindAwesomplete()
{
	var $this = $(this);
	var maxItems = $this.attr('data-maxItems');
	if(maxItems <= 3 || maxItems >= 20)
	{
		maxItems = 10;
	}
	var tmpObj = new Awesomplete(this,
	{
		minChars: 1,
		maxItems: maxItems,
		autoFirst: true,
		sort: false,
		filter: function (_text, _input)
		{
			// if we have label, search only in label, not more
			if(_text.label)
			{
				if(_text.label.indexOf(_input) >= 0)
				{
					return true;
				}
				return false;
			}
			return true;
		},
		replace: function(text)
		{
			myText = text.label;
			myText = myText.substr(0, myText.indexOf('<var>'))
			myText = $(myText).text();
			this.input.value = myText;
			// save value to data-val if it's different
			$this.attr('data-val', text.value);
		}
	});
	// bind to data to connect later
	$this.data('Awesomplete', tmpObj);
}


/**
 * [saveAutoComplete description]
 * @return {[type]} [description]
 */
function fillDataList(_this)
{
	// get vals for search
	var listName    = $(_this).attr('data-find');
	var parentCode  = $(_this).attr('data-parent');
	var searchTerm  = $(_this).val().trim();
	// prepare sended data
	var sendData    = {};
	sendData.list   = listName;
	sendData.q      = searchTerm;
	// if parent set as class or id give it value
	if(parentCode && $(parentCode).length > 0)
	{
		parentCode = $(parentCode).attr('data-val');
	}
	// if parent is set, send it
	if(parentCode !== undefined)
	{
		sendData.parent = parentCode;
	}
	// try to abort old request
	try { xhr.abort(); } catch(e){}
	// try to get new list from server
	var myAddr = $(location).attr('href');
	var xhr    = $.getJSON(myAddr, sendData, function(data)
	{
		var myAutoList = $(_this).data('Awesomplete');
		myAutoList.list = convertJson(data);
	});
}


/**
 * [convertJson description]
 * @param  {[type]} _data [description]
 * @return {[type]}       [description]
 */
function convertJson(_data)
{
	var list = clearJson(_data);
	if(!list)
	{
		list = [];
	}

	list = list.map(function(_i)
	{
		// define inner object
		var opt = {};
		opt.label = '<b>' + _i.title + '</b>';
		if(!_i.count)
		{
			_i.count = '';
		}
		opt.label += '<var>' + _i.count + '</var>';
		if(_i.desc)
		{
			opt.label += '<span>' + _i.desc + '</span>';
		}
		if(_i.translate)
		{
			opt.label += '<abbr>' + _i.translate + '</abbr>';
		}
		// set value
		opt.value = _i.title;
		if(_i.value)
		{
			opt.value = _i.value;
		}
		return opt;
	});

	return list;
}