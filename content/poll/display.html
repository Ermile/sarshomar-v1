{%extends display.main%}

{%block head_css%}
{%endblock%}

{%block content%}

{%if show_all_comments%}
  {%for key, value in all_comments%}
    <h6>minus{{value.comment_minus}}</h6>
    <h6>plus{{value.comment_plus}}</h6>
    {%set k = value.comment_rate%}{%if k > 5 %}{%set k = 5 %}{%endif%}
    {%for i in 1..k%}
        <span><i class="fa fa-star" aria-hidden="true"></i></span>
    {%endfor%}
    <div class="user">{{value.comment_author}}</div>
    <div class="content">
      <p>{{value.comment_content}}</p>
    </div>
    <span class="continue">{%trans "More"%}</span>
  {%endfor%}

{%else%}

<!-- show poll -->

<div class="row question-box">
  <article class="row auto">
    <section class="span8">
      <h2>{{post.post_title}}</h2>
{%include template.social%}

      {%if profile%}
        {%trans "This question will complete your profile"%}
      {%endif%}
      <div class="description"><p>{{post.post_content}}</p></div>
      {% if post.post_meta.opt %}
      <form method="post">
        <input type="hidden" name="data-id" value="{{post.id}}">
        {% if multiple_choice %}
        <div class="ac-custom ac-checkbox ac-checkmark" autocomplete="off">
          <ul>
           {%for key, value in post.post_meta.opt%}
            <li>
              <input type="checkbox" name="{{value.key}}" id="check_{{value.key}}" class="answer-link" data-key="{{value.key}}" value="{{value.txt}}">
              <label for="check_{{value.key}}">{{value.txt}}</label>
              <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>
            </li>
          {%endfor%}

          {% if descriptive %}
            <li>
              <input type="checkbox" id="check_other" class="answer-link" data-key="opt_{{post.post_meta.opt|length + 1}}" value="other">
              <label for="check_other"><input type="text" name="opt_other"></label>
              <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>
            </li>
          {%endif%}
          </ul>
        </div>
        {%else%}
        <div class="ac-custom ac-radio ac-fill" autocomplete="off">
          <ul>
          {%for key, value in post.post_meta.opt%}
            <li>
              <input type="radio" name="radio" id="radio_{{value.key}}" class="answer-link" data-key="{{value.key}}" value="{{value.key}}">
              <label for="radio_{{value.key}}">{{value.txt}}</label>
              <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>
            </li>
          {%endfor%}
          {% if descriptive %}
          <li>
            <input type="radio" name="radio" id="radio_other" class="answer-link" data-key="opt_{{post.post_meta.opt|length + 1}}" value="other">
            <label for="radio_other"><input type="text" name="opt_other"></label>
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>
          </li>
          {%endif%}
          </ul>
        </div>
        {%endif%}
        <div class="buttons">
          <nav class="btn-answers">
            <button class="save-anwser">ثبت رای</button>
          </nav>
        </div>
        <a class="save-anwser" data-key="opt_0" value="skip" style="cursor:pointer">skip</a>
        </form>
      {%else%}
          <div class="buttons">
            <nav class="btn-answers">
              <button class="save-anwser"><a href="ask"  data-direct style="color:black;">{%trans "Ask Me"%}</a></button>
            </nav>
          </div>
      {%endif%}

      {%if article%}
        <div class="read-more">
          <label>در همین رابطه بخوانید</label>
          <a href="{{article[0].url}}">
            <span data-hover="{{article[0].title}}">{{article[0].title}}</span>
          </a>
        </div>
      {%endif%}
    </section>

    <nav class="span4 related-questions">
    <h3>{%trans "Similar Questions"%}</h3>
      {% for key, value in similar_post()%}
         <li><a href="{{base.url}}/{{value.url}}">{{value.title}}</a></li>
      {%endfor%}
    </nav>
  </article>
</div>


{%if chart%}
<div class="row results-box">
  <section class="row results">
    <div class="type">
      <ul class="tabs">
        {%for key, value in chart%}
          {%if value.categories != 'null'%}
            <li chart-type="{{key}}" class="chart-{{key}} {% if key == 'result' %}active{%endif%}">{{key|trans}}</li>
          {%endif%}
        {%endfor%}
      </ul>
    </div>
  </section>
  <div class="container poll-chart chart"></div>
</div>
{%endif%}
<div class="row comments">
  <div class="container">
    <h4>نظرات و امتیازات</h4>
    <div class="row auto">
      <div class="span4 summary">
        <div class="average-score">
        {%if site.currentlang == "fa"%}
          {{rate.total|persian}}
        {%else%}
          {{rate.total}}
        {%endif%}
        </div><!-- /.average-score -->

        <!-- <div class="row">
          <span><i class="fa fa-2x fa-star" aria-hidden="true"></i></span>
          <span><i class="fa fa-2x fa-star" aria-hidden="true"></i></span>
          <span><i class="fa fa-2x fa-star" aria-hidden="true"></i></span>
          <span><i class="fa fa-2x fa-star" aria-hidden="true"></i></span>
          <span><i class="fa fa-2x fa-star" aria-hidden="true"></i></span>
          <span class="stars-number">
            {%if site.currentlang == "fa"%}
                {{108|persian}}
            {%else%}
                108
            {%endif%}
          </span>
        </div> --><!-- /.row -->

        <div class="bars">
          <div class="bar-one"   style="width: {{rate.rate5 * 20}}%"></div>
          <div class="bar-two"   style="width: {{rate.rate4 * 20}}%" ></div>
          <div class="bar-three" style="width: {{rate.rate3 * 20}}%" ></div>
          <div class="bar-four"  style="width: {{rate.rate2 * 20}}%" ></div>
          <div class="bar-five"  style="width: {{rate.rate1 * 20}}%" ></div>
        </div><!-- /.bars -->
      </div><!-- /.summary -->
    </div>
    <div class="row auto">
      {% for key, value in comments() %}
        <div class="span4 comment">
        <h4>minus{{value.comment_minus}}</h4>
        <h4>plus{{value.comment_plus}}</h4>
          <a class="minus" data-value="{{value.comment_minus}}" data-comment-id="{{value.id}}" style="cursor: pointer;">-</a>
          <a class="plus" data-value="{{value.comment_plus}}" data-comment-id="{{value.id}}" style="cursor: pointer;">+</a>

          <!--   <div class="score">
            <div class="plus" data-value="{{value.comment_minus}}" data-comment-id="{{value.id}}">
              <object data="/static/images/score-g.svg"></object>
            </div>
            <div class="minus" data-value="{{value.comment_plus}}" data-comment-id="{{value.id}}">
              <object data="/static/images/score-r.svg" data-value="12"></object>
            </div>
          </div> -->
          <div>
          {%set k = value.comment_rate%}{%if k > 5 %}{%set k = 5 %}{%endif%}
          {%for i in 1..k%}
              <span><i class="fa fa-star" aria-hidden="true"></i></span>
          {%endfor%}
          </div>
          <div class="user">{{value.comment_author}}</div>
          <div class="content">
            <p>{{value.comment_content}}</p>
          </div>
          <span class="continue">{%trans "More"%}</span>
        </div>
      {% endfor %}
    </div>
    <!-- heart -->
    <div class="heart" data-value="1" style="background: red; padding-top: 25px; padding-bottom: 25px; width: 100px; text-align: center; border-radius: 5px; opacity: 0.2">
      1
    </div>
    <div class="save-heart"  style="background: green; height: 30px; width: 30px; text-align: center; border-radius: 5px;">
      save
    </div>
    <!-- heart -->
    <form method="post">
        <input type="hidden" name="comment" value="comment">
        <textarea name="content" placeholder="content"></textarea>
        <input type="submit" value="send">
      </form>
  </div>
</div><!-- /.comments -->

<div class="row details">
    <div class="container">
        <div class="row auto">
            <h5>توضیحات</h5>
            <div class="span6">
                <div class="title">بازه سوال</div>
                <div class="detail">
                    <span class="green">{{date_start}}</span>
                    <span>-</span>
                    <span class="red">{{date_end}}</span>
                </div>
                <div class="title">وضعیت نظرسنجی</div>
                <div class="detail"><span class="green">{{status}}</span></div>
                <div class="title">کلیدواژه ها</div>
                <div class="detail tags">
                    {{tags({"html":true})}}
                </div>
            </div>
            <div class="span6 border">
                {%if filters %}
                <div class="title">جامعه آماری هدف:</div>
                <div class="row auto">
                  {%for key, value in filters%}
                  <div class="span6">
                    <div class="detail">
                      <span>
                        <i class="fa fa-2x fa-{{value.icon}}" aria-hidden="true"></i>
                        {{value.filter}}
                      </span>
                    </div>
                  </div>
                  {%endfor%}
                </div>
                {%endif%}
            </div>
        </div>
    </div>
</div>
<!-- show comments only -->
{%endif%}
{%endblock%}

{%block foot_js%}
<script>
$(document).ready(function(){

  $('.plus').on('click', function(){
    add_score_comment('plus', $(this).attr('data-comment-id'));
  });
  $('.minus').on('click', function(){
    add_score_comment('minus', $(this).attr('data-comment-id'));
  });
  $(".heart").on('click',function(){
    value = parseInt($(this).attr("data-value"));
    value = value + 1;
    if(value > 5)
    {
      value = 1;
    }
    $(this).attr("data-value", value);
    $(this).html(value);
    $(this).css("opacity", 0.2 * value);
  });
  $('.save-heart').on('click', function(){
    value = $(".heart").attr("data-value");
    $(this).ajaxify(
      {
        ajax:
        {
          method: 'post',
          data:
          {
            'type'  : 'heart',
            'data'  : value
          },
          abort: true,
          success: function(e, data, x)
          {

          }
        }
      });
  });
});
function add_score_comment(_type, _data_id)
{
  $(this).ajaxify(
      {
        ajax:
        {
          method: 'post',
          data:
          {
            'type'  : _type,
            'data'  : _data_id
          },
          abort: true,
          success: function(e, data, x)
          {

          }
        }
      });
}

$(".save-anwser").on("ajaxify:success", function(_xhr, _data){
    // next_url = _data.msg.callback;
    // $(".btn-answers").children().remove();
    // $("<button class='save-anwser'><a href='{{base.url}}/" + next_url + "' style='color:black;' data-direct>سوال بعدی</a></button>").appendTo(".buttons");
    // $("div.opt").fadeOut();
});


function bookmark(_poll_id) {
    $.ajax(
    {
        type: 'get',
        // url: '@/polls',
        data:
        {
          'type'    : 'bookmark',
          'poll_id' : _poll_id
        },
        success: function(data)
        {
           // console.log(data);
        }
    });
}
$('.poll-chart').highcharts(load_chart('result'));

$(".tabs li").click(function(){
    type = $(this).attr("chart-type");
    $('.poll-chart').highcharts(load_chart(type));
});

function load_chart(_type)
{
    if(_type == 'result')
    {
        var result = {
            chart: {type: 'column', backgroundColor: 'rgba(255, 255, 255, 0)'
                // events: {
                //     load: function() {
                //         var check = $('.top-chart').highcharts();
                //         check.yAxis[0].setExtremes(null, check.axes[1].dataMax);
                //     }
                // }
            },
            exporting: {enabled: false},
            credits: {enabled: false},
            title : "",xAxis: { labels: { enabled: false }, categories: ['']},
            yAxis: {min: 0,title: {text: 'درصد',enabled: false},labels: {enabled: false},gridLineWidth: 0,minorGridLineWidth: 0,},
            legend: {enabled: false },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' + '<td style="padding:0"><b>{point.y:.1f} %</b></td></tr>',
                footerFormat: '</table>',
                shared: false,
                useHTML: true
            }, plotOptions: {column: {pointPadding: 0.2, borderWidth: 0}},
            series: eval({{chart.result.data| raw }})
        };
        return result;
    }
    data_chart =  {{chart|json_encode(constant("JSON_UNESCAPED_UNICODE"))|raw}};

     data = {chart: {type: 'column'},
        title: {text: data_chart[_type].title},
        xAxis: {categories: eval(data_chart[_type].categories) },
        yAxis: {min: 0,title: {text: 'مجموع رای دهنگان'},
            stackLabels: {enabled: true,style: {fontWeight: 'bold',
                    color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                }
            }
        },
        legend: {align: 'right',x: -30,verticalAlign: 'top',y: 25, floating: true,
            backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
            borderColor: '#CCC',
            borderWidth: 1,
            shadow: false
        },
        tooltip: {
            headerFormat: '<b>{point.x}</b><br/>',
            pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
        },
        plotOptions: {
            column: {
                stacking: 'normal',
                dataLabels: {
                    enabled: true,
                    color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
                }
            }
        },
        series: eval(data_chart[_type].series)
    };

    return data;

}

$(function() {

    // $('.poll-chart').highcharts(x);
    $(".comments .comment .continue").click(function() {
        $(this).parents('.comment').children('.content').addClass('absolute-content');
        event.preventDefault();
            event.stopPropagation();
        $(".absolute-content").click(function(event){
            event.preventDefault();
            event.stopPropagation();
        });
    });
    $('body').click(function(event) {
        $(".content.absolute-content").removeClass("absolute-content");
    });
});

</script>
<script type="text/javascript" src="/static/js/svgcheckbox.js"></script>
{%endblock%}
